@page "/"

@using DiagonalDuel_Web.Logic
@using System.Globalization

<h1>Diagonal Duel</h1>
<div class="main-container">
@if (isGameOver)
{
    <h3>Game Over!</h3>
    <p>Your final score is: <strong>@score</strong></p>
    <button class="btn btn-primary" @onclick="StartNewGame">Play Again</button>
}
else
{
    <p><strong>Round @round of @maxRounds</strong></p>
    <p>Guess the absolute difference between the matrix diagonals:</p>

    <table class="table table-bordered table-sm w-auto mx-auto text-center">
        <tbody>
            @for(int i = 0; i < matrix.Count; i++)
            {
                <tr>
                    @for(int j = 0; j < matrix[i].Count; j++)
                    {
                        string cellClass = "";
                        
                        if(i == j && i == (matrix.Count - j - 1)) // Overlapping diagnonals
                        {
                            cellClass = "bg-warning text-dark";
                        }else if(i == j) // primary diagonal
                        {
                            cellClass = "bg-primary text-white";
                        }else if(i == (matrix.Count - j - 1)) // secondary diagonal
                        {
                            cellClass = "bg-success text-white";
                        }

                        <td class="@cellClass" style="width:40px; height: 40px; vertical-align: middle;">@matrix[i][j]</td>
                    }
                </tr>
            }
        </tbody>
    </table>

    <input type="number" @bind="userGuess" class="form-control" placeholder="Enter your guess" />
    <button class="btn btn-success " @onclick="SubmitGuess">Submit</button>

    @if (!string.IsNullOrWhiteSpace(feedback))
    {
        <p class="mt-3">@feedback</p>
        <p>Current Score: <strong>@score</strong></p>
    }
}
</div>

@code
{
    private int round = 1;
    private int maxRounds = 5;
    private int score = 0;
    private int userGuess = 0;
    private string feedback = "";
    private bool isGameOver = false;

    private List<List<int>> matrix = new();

    protected override void OnInitialized()
    {
        GenerateNewMatrix();
    }

    private void GenerateNewMatrix()
    {
        matrix = GameLogic.GenerateRandomMatrix(new Random().Next(2, 6));
    }

    private void SubmitGuess()
    {
        int correctAnswer = GameLogic.DiagonalDifference(matrix);
        int difference = Math.Abs(userGuess - correctAnswer);

        if (difference == 0)
        {
            feedback = "Perfect guess!";
            score += 2;
        }
        else if (difference <= 2)
        {
            feedback = $"Almost! You were off by {difference}.";
            score += 1;
        }
        else
        {
            feedback = "Too far off!";
        }

        round++;

        if (round > maxRounds)
        {
            isGameOver = true;
        }
        else
        {
            GenerateNewMatrix();
            userGuess = 0;
        }
    }

    private void StartNewGame()
    {
        round = 1;
        score = 0;
        feedback = "";
        isGameOver = false;
        GenerateNewMatrix();
    }
}
